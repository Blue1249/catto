name: Deploying Catto Botto

on:
  workflow_dispatch:
    inputs:
        environment:
            description: 'Environment to run tests against'
            type: environment
            required: true   
            
jobs:
  deploy:
    runs-on: [self-hosted, Linux, x64, catto]
    environment: ${{ github.event.inputs.environment }}

    env:
      DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN }}
      CLASH_TOKEN: ${{ secrets.CLASH_TOKEN }}
      MONGO_URI: ${{ secrets.MONGO_URI }}    

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup configuration
        run: |
          cp config.json.copy config.json
          cp emojis.json.copy emojis.json
          cp .env.copy .env

      - name: Run npm install
        run: npm install
      - name: deploy-commands.js
        run: node deploy-commands.js
      - name: Start bot with PM2
        run: |
          pm2 delete catto-botto || true  
          pm2 start index.js --name catto-botto
          pm2 save  